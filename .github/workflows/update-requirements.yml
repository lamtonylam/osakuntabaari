name: Update requirements.txt

on:
    push:
        branches: [main]
    workflow_dispatch:

jobs:
    update-requirements:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Run uv export in container
              run: |
                  docker run --rm -v "${{ github.workspace }}:/workspace" -w /workspace ghcr.io/astral-sh/uv:latest \
                    uv export --no-emit-workspace --no-dev --no-annotate --no-header --no-hashes --output-file requirements.txt

            - name: Commit and push requirements.txt if changed
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add requirements.txt
                  # If there are no staged changes, exit successfully without committing
                  if git diff --cached --quiet; then
                    echo "No changes to requirements.txt"
                    exit 0
                  fi
                  git commit -m "chore: update requirements.txt (uv export)"
                  git push origin HEAD:main
